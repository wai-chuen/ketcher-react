{"code":"/****************************************************************************\r\n * Copyright 2021 EPAM Systems\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *    http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n ***************************************************************************/\r\nimport { Vec2, fromBondAlign, fromFlip, fromItemsFuse, fromRotate, getHoverToFuse, getItemsToFuse } from 'ketcher-core';\r\nimport utils from '../shared/utils';\r\nclass RotateTool {\r\n    editor;\r\n    dragCtx;\r\n    isNotActiveTool;\r\n    constructor(editor, dir) {\r\n        this.editor = editor;\r\n        if (dir) {\r\n            const restruct = editor.render.ctab;\r\n            const selection = editor.selection();\r\n            const singleBond = selection &&\r\n                selection.bonds &&\r\n                Object.keys(selection).length === 1 &&\r\n                selection.bonds.length === 1;\r\n            const action = !singleBond\r\n                ? fromFlip(restruct, selection, dir, null)\r\n                : fromBondAlign(restruct, selection.bonds[0], dir);\r\n            editor.update(action);\r\n            this.isNotActiveTool = true;\r\n            return;\r\n        }\r\n        if (!editor.selection() || !editor.selection()?.atoms) {\r\n            // otherwise, clear selection\r\n            this.editor.selection(null);\r\n        }\r\n    }\r\n    mousedown(event) {\r\n        let xy0 = new Vec2();\r\n        const selection = this.editor.selection();\r\n        const rnd = this.editor.render;\r\n        const struct = rnd.ctab.molecule;\r\n        if (selection && selection.atoms) {\r\n            let rotId = null;\r\n            let rotAll = false;\r\n            selection.atoms.forEach((aid) => {\r\n                const atom = struct.atoms.get(aid);\r\n                xy0.add_(atom?.pp); // eslint-disable-line no-underscore-dangle\r\n                if (rotAll)\r\n                    return;\r\n                atom?.neighbors.find((nei) => {\r\n                    const hb = struct.halfBonds.get(nei);\r\n                    if (hb) {\r\n                        if (selection.atoms?.indexOf(hb.end) === -1) {\r\n                            if (hb.loop >= 0) {\r\n                                const neiAtom = struct.atoms.get(aid);\r\n                                if (!neiAtom?.neighbors.find((neiNei) => {\r\n                                    const neiHb = struct.halfBonds.get(neiNei);\r\n                                    return (neiHb?.loop >= 0 &&\r\n                                        selection.atoms?.indexOf(neiHb?.end) !== -1);\r\n                                })) {\r\n                                    rotAll = true;\r\n                                    return true;\r\n                                }\r\n                            }\r\n                            if (rotId == null) {\r\n                                rotId = aid;\r\n                            }\r\n                            else if (rotId !== aid) {\r\n                                rotAll = true;\r\n                                return true;\r\n                            }\r\n                        }\r\n                    }\r\n                    return false;\r\n                });\r\n            });\r\n            if (!rotAll && rotId !== null) {\r\n                xy0 = struct.atoms.get(rotId)?.pp;\r\n            }\r\n            else {\r\n                xy0 = xy0.scaled(1 / selection.atoms.length);\r\n            }\r\n        }\r\n        else if (struct.atoms?.size) {\r\n            struct.atoms.forEach((atom) => {\r\n                xy0.add_(atom.pp);\r\n            }); // eslint-disable-line no-underscore-dangle, max-len\r\n            // poor man struct center (without sdata, etc)\r\n            xy0 = xy0.scaled(1 / struct.atoms.size);\r\n        }\r\n        else {\r\n            xy0 = rnd.page2obj(event);\r\n        }\r\n        this.dragCtx = {\r\n            xy0,\r\n            angle1: utils.calcAngle(xy0, rnd.page2obj(event))\r\n        };\r\n        return true;\r\n    }\r\n    mousemove(event) {\r\n        if (!this.dragCtx) {\r\n            this.editor.hover(null, null, event);\r\n            return true;\r\n        }\r\n        const rnd = this.editor.render;\r\n        const dragCtx = this.dragCtx;\r\n        const pos = rnd.page2obj(event);\r\n        let angle = utils.calcAngle(dragCtx.xy0, pos) - dragCtx.angle1;\r\n        if (!event.ctrlKey) {\r\n            angle = utils.fracAngle(angle, null);\r\n        }\r\n        const degrees = utils.degrees(angle);\r\n        if ('angle' in dragCtx && dragCtx.angle === degrees) {\r\n            return true;\r\n        }\r\n        if ('action' in dragCtx) {\r\n            dragCtx.action.perform(rnd.ctab);\r\n        }\r\n        dragCtx.angle = degrees;\r\n        dragCtx.action = fromRotate(rnd.ctab, this.editor.selection(), dragCtx.xy0, angle);\r\n        this.editor.event.message.dispatch({ info: degrees + 'ยบ' });\r\n        const expSel = this.editor.explicitSelected();\r\n        dragCtx.mergeItems = getItemsToFuse(this.editor, expSel);\r\n        this.editor.hover(getHoverToFuse(dragCtx.mergeItems), null, event);\r\n        this.editor.update(dragCtx.action, true);\r\n        return true;\r\n    }\r\n    mouseup() {\r\n        if (!this.dragCtx) {\r\n            return true;\r\n        }\r\n        const dragCtx = this.dragCtx;\r\n        const restruct = this.editor.render.ctab;\r\n        const action = dragCtx.action\r\n            ? fromItemsFuse(restruct, dragCtx.mergeItems).mergeWith(dragCtx.action)\r\n            : fromItemsFuse(restruct, dragCtx.mergeItems);\r\n        delete this.dragCtx;\r\n        this.editor.update(action);\r\n        if (dragCtx.mergeItems) {\r\n            this.editor.selection(null);\r\n        }\r\n        this.editor.event.message.dispatch({\r\n            info: false\r\n        });\r\n        return true;\r\n    }\r\n    cancel() {\r\n        this.mouseup();\r\n    }\r\n    mouseleave() {\r\n        this.mouseup();\r\n    }\r\n}\r\nexport default RotateTool;\r\n//# sourceMappingURL=rotate.js.map","references":["/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-core/dist/index.d.ts","/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-react/src/script/editor/shared/utils.js","/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-react/src/script/editor/Editor.ts"],"map":"{\"version\":3,\"file\":\"rotate.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/script/editor/tool/rotate.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-react/node_modules/.cache/rollup-plugin-typescript2/placeholder/script/editor/tool/rotate.d.ts","writeByteOrderMark":false,"text":"/****************************************************************************\r\n * Copyright 2021 EPAM Systems\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *    http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n ***************************************************************************/\r\nimport Editor from '../Editor';\r\ndeclare class RotateTool {\r\n    editor: Editor;\r\n    dragCtx: any;\r\n    isNotActiveTool: boolean | undefined;\r\n    constructor(editor: any, dir: any);\r\n    mousedown(event: any): boolean;\r\n    mousemove(event: any): boolean;\r\n    mouseup(): boolean;\r\n    cancel(): void;\r\n    mouseleave(): void;\r\n}\r\nexport default RotateTool;\r\n"}}
